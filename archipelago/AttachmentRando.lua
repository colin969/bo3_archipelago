local weapon_attachments = {
    -- Assault Rifles
    {
        name = "ar_garand",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_galil",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_famas",
        sights_large = {"acog", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_m16",
        sights_large = {"acog", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_standard",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_marksman",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_longburst",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_damage",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_cqb",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "ar_accurate",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    
    -- LMGs
    {
        name = "lmg_rpk",
        sights_large = {"acog", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "lmg_slowfire",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "lmg_light",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "lmg_heavy",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "lmg_cqb",
        sights_large = {"acog", "dualoptic", "ir"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    
    -- SMGs
    {
        name = "smg_ak74u",
        sights_large = {"none", "holo", "reddot", "reflex"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_versatile",
        sights_large = {"acog", "dualoptic"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_standard",
        sights_large = {"acog", "dualoptic"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_ppsh",
        sights_large = {"none"},
        sights_small = {"none"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_fastfire",
        sights_large = {"acog", "dualoptic"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_capacity",
        sights_large = {"acog", "dualoptic"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_longrange",
        sights_large = {"acog", "dualoptic"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_burst",
        sights_large = {"acog", "dualoptic"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "smg_mp40",
        sights_large = {"none", "holo", "reddot", "reflex"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "fmj", "grip", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    
    -- Shotguns
    {
        name = "shotgun_semiauto",
        sights_large = {"none", "holo", "reddot", "reflex"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "shotgun_pump",
        sights_large = {"none", "holo", "reddot", "reflex"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "shotgun_precision",
        sights_large = {"none", "holo", "reddot", "reflex"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "shotgun_fullauto",
        sights_large = {"none", "holo", "reddot", "reflex"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    {
        name = "shotgun_energy",
        sights_large = {"none", "holo", "reddot", "reflex"},
        sights_small = {"none", "holo", "reddot", "reflex"},
        attachments = {"extbarrel", "extclip", "fastreload", "quickdraw", "rf", "stalker", "steadyaim", "suppressed"}
    },
    
    -- Pistols
    {
        name = "pistol_fullauto",
        sights_large = {"none", "reddot", "reflex"},
        sights_small = {"none", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "quickdraw", "steadyaim", "suppressed"}
    },
    {
        name = "pistol_burst",
        sights_large = {"none", "reddot", "reflex"},
        sights_small = {"none", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "quickdraw", "steadyaim", "suppressed"}
    },
    {
        name = "pistol_energy",
        sights_large = {"none", "reddot", "reflex"},
        sights_small = {"none", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "quickdraw", "steadyaim", "suppressed"}
    },
    {
        name = "pistol_m1911",
        sights_large = {"none", "reddot", "reflex"},
        sights_small = {"none", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "quickdraw", "steadyaim", "suppressed"}
    },
    {
        name = "pistol_standard",
        sights_large = {"none", "reddot", "reflex"},
        sights_small = {"none", "reddot", "reflex"},
        attachments = {"damage", "extbarrel", "extclip", "fastreload", "fmj", "quickdraw", "steadyaim", "suppressed"}
    },
    
    -- Snipers
    {
        name = "sniper_fastsemi",
        sights_large = {"none", "acog", "dualoptic", "ir"},
        sights_small = {"reddot"},
        attachments = {"extclip", "fastreload", "fmj", "rf", "stalker", "suppressed", "swayreduc"}
    },
    {
        name = "sniper_powerbolt",
        sights_large = {"none", "acog", "dualoptic", "ir"},
        sights_small = {"reddot"},
        attachments = {"extclip", "fastreload", "fmj", "rf", "stalker", "suppressed", "swayreduc"}
    },
    {
        name = "sniper_fastbolt",
        sights_large = {"none", "acog", "dualoptic", "ir"},
        sights_small = {"reddot"},
        attachments = {"extclip", "fastreload", "fmj", "rf", "stalker", "suppressed", "swayreduc"}
    }
}

function generate_weapon_attachments_for_seed(seed, sight_weight)
    -- Make consistent for seed I guess
    -- Why can't it just take a string smh
    local numeric_seed = 0
    for i = 1, #seed do
        -- Multi by pos so abc doesn't equal cba
        numeric_seed = numeric_seed + (string.byte(seed, i) * i)
    end
    math.randomseed(numeric_seed)
    
    local dw_weapons = {
        "pistol_standard_upgraded",
        "pistol_m1911_upgraded", 
        "pistol_revolver38_upgraded",
        "pistol_shotgun_dw",
        "pistol_shotgun_dw_upgraded"
    }
    
    local function shuffle_array(arr)
        local shuffled = {}
        for i, v in ipairs(arr) do
            shuffled[i] = v
        end
        for i = #shuffled, 2, -1 do
            local j = math.random(i)
            shuffled[i], shuffled[j] = shuffled[j], shuffled[i]
        end
        return shuffled
    end
    
    local function has_value(arr, val)
        for _, v in ipairs(arr) do
            if v == val then return true end
        end
        return false
    end
    
    local function remove_value(arr, val)
        for i, v in ipairs(arr) do
            if v == val then
                table.remove(arr, i)
                return
            end
        end
    end
    
    local generated_weapons = {}
    
    -- Iterate through all weapons
    for _, weapon_data in ipairs(weapon_attachments) do
        local weapon_name = weapon_data.name
        local attachments = {}
        local sight = nil
        
        -- Generate sight
        if weapon_data.sights_large and #weapon_data.sights_large > 0 then
            if math.random(100) < sight_weight then
                sight = weapon_data.sights_large[math.random(#weapon_data.sights_large)]
            else
                sight = weapon_data.sights_small[math.random(#weapon_data.sights_small)]
            end
            table.insert(attachments, sight)
        end
        
        -- Generate attachments
        if weapon_data.attachments and #weapon_data.attachments > 0 then
            local num_attachments = math.min(3, #weapon_data.attachments)
            local attachment_bag = shuffle_array(weapon_data.attachments)
            
            for i = 1, num_attachments do
                table.insert(attachments, attachment_bag[i])
            end
        end
        
        -- Add dual wield for pistols that usually have it
        if has_value(dw_weapons, weapon_name) then
            table.insert(attachments, 1, "dw")
        end
        
        -- 25% chance to go with sway reduction over a sightless sniper unless small sight is guaranteed
        if sight and has_value(attachments, "swayreduc") then
            if math.random(3) ~= 1 and sight_weight > 0 then
                remove_value(attachments, sight)
            else
                remove_value(attachments, "swayreduc")
            end
        end
        
        generated_weapons[weapon_name] = attachments
    end
    
    return generated_weapons
end

function load_attachments_into_gsc(attachment_data)
    for weapon_name, attachments in pairs(attachment_data) do
        Engine.SetDvar("ARCHIPELAGO_ATTACHMENT_RANDO_" .. string.upper(weapon_name), table.concat(attachments, "+"))
    end
end

return {
    weapon_attachments = weapon_attachments,
    generate_weapon_attachments_for_seed = generate_weapon_attachments_for_seed,
    load_attachments_into_gsc = load_attachments_into_gsc,
}
